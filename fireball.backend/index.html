<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fireball</title>
    <meta name="description"
        content="Strategic battle game powered by machine learning. Challenge the AI or play against friends online.">
    <link rel="icon" type="image/svg+xml" href="/fireball_logo.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Nunito+Sans:opsz,wght@6..12,400;6..12,500;6..12,600;6..12,700;6..12,800&display=swap"
        rel="stylesheet">

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        :root {
            --fire-red: #dc2626;
            --fire-orange: #ea580c;
            --fire-amber: #f59e0b;
            --accent-purple: #7c3aed;
            --accent-indigo: #4f46e5;
            --bg-primary: #0c0a14;
            --bg-secondary: #14101f;
            --bg-card: #1a1528;
            --bg-card-hover: #221d32;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-subtle: rgba(255, 255, 255, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito Sans', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .app {
            min-height: 100vh;
            padding: 2rem;
        }

        /* Homepage */
        .home-container {
            min-height: calc(100vh - 4rem);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 12vh;
            gap: 3rem;
        }

        .home-header {
            text-align: center;
        }

        .home-logo {
            width: 80px;
            height: 80px;
            margin-bottom: 1rem;
        }

        .home-title {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--fire-red), var(--fire-orange), var(--fire-amber));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .home-subtitle {
            color: var(--text-secondary);
            font-size: 1.125rem;
            margin-top: 0.5rem;
        }

        .home-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            max-width: 900px;
            width: 100%;
        }

        .home-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            padding: 2.5rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .home-card:hover {
            background: var(--bg-card-hover);
            transform: translateY(-4px);
            border-color: var(--fire-orange);
        }

        .home-card-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
        }

        .home-card-desc {
            color: var(--text-secondary);
            font-size: 0.9375rem;
        }

        /* Removed permanent primary styling - all cards look the same now */

        /* Admin button */
        .admin-trigger {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            width: 32px;
            height: 32px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            cursor: pointer;
            opacity: 0.3;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .admin-trigger:hover {
            opacity: 1;
        }

        /* Game page */
        .game-container {
            max-width: 700px;
            margin: 0 auto;
        }

        .game-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .game-logo {
            width: 48px;
            height: 48px;
        }

        .game-title {
            font-size: 1.75rem;
            font-weight: 700;
        }

        .back-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9375rem;
            font-family: inherit;
            margin-left: auto;
        }

        .back-btn:hover {
            color: var(--text-primary);
        }

        .charge-display {
            display: flex;
            justify-content: space-between;
            padding: 2rem 3rem;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            margin-bottom: 2rem;
        }

        .charge-block {
            text-align: center;
            flex: 1;
        }

        .charge-label {
            font-size: 0.8125rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .charge-value {
            font-size: 4rem;
            font-weight: 800;
            line-height: 1;
        }

        .player-charge .charge-label {
            color: var(--fire-orange);
        }

        .opponent-charge .charge-label {
            color: var(--accent-purple);
        }

        .moves-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
        }

        .move-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding: 1.5rem 0.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .move-btn:hover:not(:disabled) {
            background: var(--bg-card-hover);
            border-color: var(--fire-orange);
        }

        .move-btn:disabled {
            opacity: 0.35;
            cursor: not-allowed;
        }

        .move-btn .cost {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 400;
        }

        .history-section {
            margin-top: 2.5rem;
        }

        .history-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            font-size: 0.875rem;
        }

        .history-item span {
            color: var(--text-secondary);
        }

        .history-item .you {
            color: var(--fire-orange);
        }

        .history-item .opp {
            color: var(--accent-purple);
        }

        /* End game */
        .end-game {
            text-align: center;
            padding: 3rem 2rem;
        }

        .end-title {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 1rem;
        }

        .end-title.win {
            color: var(--fire-orange);
        }

        .end-title.lose {
            color: var(--text-secondary);
        }

        .end-subtitle {
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        .btn {
            padding: 1rem 2rem;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--fire-red), var(--fire-orange));
            color: white;
        }

        .btn-primary:hover {
            filter: brightness(1.1);
        }

        .btn-secondary {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
        }

        /* Guide page */
        .guide-container {
            max-width: 700px;
            margin: 0 auto;
        }

        .guide-content {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            padding: 2.5rem;
        }

        .guide-content h2 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .guide-content h3 {
            font-size: 1.125rem;
            margin-top: 2rem;
            margin-bottom: 0.75rem;
            color: var(--fire-orange);
        }

        .guide-content p {
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .guide-content ul {
            list-style: none;
            padding: 0;
        }

        .guide-content li {
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-subtle);
            color: var(--text-secondary);
        }

        .guide-content li:last-child {
            border-bottom: none;
        }

        .guide-content strong {
            color: var(--text-primary);
        }

        /* 1v1 */
        .matchmaking-status {
            text-align: center;
            padding: 3rem;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
        }

        .matchmaking-status p {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }

        .input-field {
            width: 100%;
            max-width: 300px;
            padding: 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--accent-purple);
        }

        /* Stats modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            padding: 2rem;
            max-width: 500px;
            width: 90%;
        }

        .modal h3 {
            margin-bottom: 1.5rem;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: var(--text-secondary);
        }

        .stat-value {
            font-weight: 700;
        }

        /* Alert */
        .alert {
            padding: 1rem;
            background: rgba(220, 38, 38, 0.15);
            border: 1px solid rgba(220, 38, 38, 0.3);
            color: #fca5a5;
            margin-bottom: 1.5rem;
        }

        /* Loader */
        .loader {
            width: 32px;
            height: 32px;
            border: 3px solid var(--bg-secondary);
            border-top-color: var(--fire-orange);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Mobile */
        @media (max-width: 768px) {
            .app {
                padding: 1rem;
            }

            .home-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .home-title {
                font-size: 2rem;
            }

            .moves-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .charge-display {
                padding: 1.5rem;
            }

            .charge-value {
                font-size: 3rem;
            }

            .guide-content {
                padding: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .moves-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;
        const { createRoot } = ReactDOM;

        const ADMIN_HASH = '7aaba46bd7b8139d93b3c843825a411d90d6f5adfcbf0c3766a90e72dfc1d4e7';

        const MOVES = [
            { id: 'charge', name: 'Charge', cost: 0, costDisplay: '+1' },
            { id: 'shield', name: 'Shield', cost: 0, costDisplay: '0' },
            { id: 'fireball', name: 'Fireball', cost: 1, costDisplay: '-1' },
            { id: 'iceball', name: 'Iceball', cost: 2, costDisplay: '-2' },
            { id: 'megaball', name: 'Megaball', cost: 5, costDisplay: '-5' }
        ];

        const getLegalMoves = (charges) => {
            return MOVES.filter(m => {
                if (m.id === 'charge' || m.id === 'shield') return true;
                return charges >= m.cost;
            }).map(m => m.id);
        };

        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function HomePage({ onNavigate, onlineCount }) {
            const [showAdminModal, setShowAdminModal] = useState(false);
            const [adminPassword, setAdminPassword] = useState('');
            const [isAdmin, setIsAdmin] = useState(false);
            const [stats, setStats] = useState(null);

            const handleAdminLogin = async () => {
                const hash = await sha256(adminPassword);
                if (hash === ADMIN_HASH) {
                    setIsAdmin(true);
                    fetchStats();
                } else {
                    alert('Incorrect password');
                }
                setAdminPassword('');
            };

            const fetchStats = async () => {
                try {
                    const res = await fetch('/api/stats');
                    const data = await res.json();
                    setStats(data);
                } catch (e) {
                    setStats({ error: 'Failed to load stats' });
                }
            };

            return (
                <div className="home-container">
                    <div className="home-header">
                        <img src="/fireball_logo.png" alt="Fireball" className="home-logo" />
                        <h1 className="home-title">Fireball</h1>
                        <p className="home-subtitle">Strategic battle game powered by machine learning</p>
                    </div>

                    <div className="home-grid">
                        <div className="home-card" onClick={() => onNavigate('play-ai')}>
                            <h2 className="home-card-title">Play vs ML Model</h2>
                            <p className="home-card-desc">Challenge the Q-learning AI trained on thousands of games</p>
                        </div>

                        <div className="home-card" onClick={() => onNavigate('guide')}>
                            <h2 className="home-card-title">How to Play</h2>
                            <p className="home-card-desc">Learn the rules and master the strategy</p>
                        </div>

                        <div className="home-card" onClick={() => onNavigate('play-1v1')}>
                            <h2 className="home-card-title">Play Online</h2>
                            <p className="home-card-desc">Real-time matches against other players</p>
                        </div>
                    </div>

                    {onlineCount > 0 && (
                        <div style={{ marginTop: '2rem', color: 'var(--text-secondary)', fontSize: '0.875rem', textAlign: 'center' }}>
                            <span style={{ display: 'inline-block', width: '8px', height: '8px', borderRadius: '50%', background: '#22c55e', marginRight: '8px' }}></span>
                            {onlineCount} player{onlineCount !== 1 ? 's' : ''} online
                        </div>
                    )}

                    <button className="admin-trigger" onClick={() => setShowAdminModal(true)}>
                        A
                    </button>

                    {showAdminModal && (
                        <div className="modal-overlay" onClick={() => { setShowAdminModal(false); setIsAdmin(false); }}>
                            <div className="modal" onClick={e => e.stopPropagation()}>
                                {!isAdmin ? (
                                    <>
                                        <h3>Admin Access</h3>
                                        <input
                                            type="password"
                                            className="input-field"
                                            placeholder="Password"
                                            value={adminPassword}
                                            onChange={e => setAdminPassword(e.target.value)}
                                            onKeyDown={e => e.key === 'Enter' && handleAdminLogin()}
                                        />
                                        <button className="btn btn-primary" onClick={handleAdminLogin}>
                                            Login
                                        </button>
                                    </>
                                ) : (
                                    <>
                                        <h3>Statistics</h3>
                                        {stats ? (
                                            stats.error ? (
                                                <p style={{ color: 'var(--text-secondary)' }}>{stats.error}</p>
                                            ) : (
                                                <>
                                                    <div className="stat-row">
                                                        <span className="stat-label">Unique Visitors</span>
                                                        <span className="stat-value">{stats.uniqueVisitors || 0}</span>
                                                    </div>
                                                    <div className="stat-row">
                                                        <span className="stat-label">AI Win Rate</span>
                                                        <span className="stat-value">{stats.aiWinRate || 0}%</span>
                                                    </div>
                                                    <div className="stat-row">
                                                        <span className="stat-label">Total AI Games</span>
                                                        <span className="stat-value">{stats.aiGames || 0}</span>
                                                    </div>
                                                    <div className="stat-row">
                                                        <span className="stat-label">Avg Match Length</span>
                                                        <span className="stat-value">{stats.avgMatchLength || 0} rounds</span>
                                                    </div>
                                                </>
                                            )
                                        ) : (
                                            <div className="loader"></div>
                                        )}
                                    </>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function GuidePage({ onNavigate }) {
            return (
                <div className="guide-container">
                    <div className="game-header">
                        <img src="/fireball_logo.png" alt="" className="game-logo" />
                        <h1 className="game-title">How to Play</h1>
                        <button className="back-btn" onClick={() => onNavigate('home')}>Back to Menu</button>
                    </div>

                    <div className="guide-content">
                        <h2>The Basics</h2>
                        <p>
                            Fireball is a turn-based strategy game where you and your opponent choose moves simultaneously.
                            The goal is simple: land a successful attack on your opponent before they get you.
                        </p>

                        <h3>Moves</h3>
                        <ul>
                            <li>
                                <strong>Charge</strong> - Gain 1 energy. You need energy to use attacks.
                                This is your bread and butter, but be careful - you are vulnerable while charging.
                            </li>
                            <li>
                                <strong>Shield</strong> - Blocks all attacks except Megaball. Costs nothing.
                                Use it when you think your opponent is about to attack.
                            </li>
                            <li>
                                <strong>Fireball</strong> - Costs 1 energy. Defeats an opponent who is charging.
                                Gets blocked by Shield and beaten by Iceball.
                            </li>
                            <li>
                                <strong>Iceball</strong> - Costs 2 energy. Defeats Fireball and Charge.
                                Still gets blocked by Shield.
                            </li>
                            <li>
                                <strong>Megaball</strong> - Costs 5 energy. Instantly wins the game.
                                Cannot be blocked. Only countered by another Megaball.
                            </li>
                        </ul>

                        <h3>Strategy Tips</h3>
                        <p>
                            The game is all about reading your opponent. If they just used their last charge on an attack,
                            they will probably need to charge again - perfect time for a Fireball. If you have been
                            charging a lot, they might expect an attack and Shield - so maybe charge one more time.
                        </p>
                        <p>
                            The Megaball race is real. Once someone hits 4 or 5 charges, the pressure is on.
                            Do you try to rush them down, or go for your own Megaball?
                        </p>

                        <h3>Playing the AI</h3>
                        <p>
                            The ML model has been trained on thousands of games using Q-learning.
                            It learns patterns and will adapt to predictable play. Mix up your strategy to keep it guessing.
                        </p>

                        <button className="btn btn-primary" onClick={() => onNavigate('play-ai')} style={{ marginTop: '2rem' }}>
                            Start Playing
                        </button>
                    </div>
                </div>
            );
        }

        function PlayAIPage({ onNavigate }) {
            const [game, setGame] = useState({ playerCharges: 0, aiCharges: 0, gameOver: false, winner: null });
            const [history, setHistory] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            const legalMoves = getLegalMoves(game.playerCharges);

            const handleMove = async (move) => {
                setLoading(true);
                setError(null);

                try {
                    const res = await fetch('/api/play_ai', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            playerMove: move,
                            playerCharges: game.playerCharges,
                            aiCharges: game.aiCharges,
                            moveHistory: history.map(h => h.player),
                            oppMoveHistory: history.map(h => h.ai)
                        })
                    });

                    if (!res.ok) throw new Error('Request failed');

                    const data = await res.json();

                    setGame({
                        playerCharges: data.playerCharges,
                        aiCharges: data.aiCharges,
                        gameOver: data.gameOver,
                        winner: data.winner
                    });

                    setHistory([{ player: move, ai: data.aiMove, result: data.result }, ...history]);
                } catch (e) {
                    setError('Failed to connect to the AI backend.');
                }

                setLoading(false);
            };

            const resetGame = () => {
                setGame({ playerCharges: 0, aiCharges: 0, gameOver: false, winner: null });
                setHistory([]);
                setError(null);
            };

            return (
                <div className="game-container">
                    <div className="game-header">
                        <img src="/fireball_logo.png" alt="" className="game-logo" />
                        <h1 className="game-title">vs ML Model</h1>
                        <button className="back-btn" onClick={() => onNavigate('home')}>Back</button>
                    </div>

                    {error && <div className="alert">{error}</div>}

                    <div className="charge-display">
                        <div className="charge-block player-charge">
                            <div className="charge-label">Your Charges</div>
                            <div className="charge-value">{game.playerCharges}</div>
                        </div>
                        <div className="charge-block opponent-charge">
                            <div className="charge-label">AI Charges</div>
                            <div className="charge-value">{game.aiCharges}</div>
                        </div>
                    </div>

                    {game.gameOver ? (
                        <div className="end-game">
                            <h2 className={`end-title ${game.winner === 'player1' ? 'win' : 'lose'}`}>
                                {game.winner === 'player1' ? 'You Win' : 'AI Wins'}
                            </h2>
                            <p className="end-subtitle">
                                {game.winner === 'player1'
                                    ? 'Nice work. You outplayed the model.'
                                    : 'The AI predicted your moves. Try a different strategy.'}
                            </p>
                            <button className="btn btn-primary" onClick={resetGame}>Play Again</button>
                        </div>
                    ) : (
                        <div className="moves-grid">
                            {MOVES.map(move => (
                                <button
                                    key={move.id}
                                    className="move-btn"
                                    disabled={loading || !legalMoves.includes(move.id)}
                                    onClick={() => handleMove(move.id)}
                                >
                                    <span>{move.name}</span>
                                    <span className="cost">{move.costDisplay}</span>
                                </button>
                            ))}
                        </div>
                    )}

                    {loading && <div className="loader"></div>}

                    {history.length > 0 && (
                        <div className="history-section">
                            <h3 className="history-title">History</h3>
                            <div className="history-list">
                                {history.map((h, i) => (
                                    <div key={i} className="history-item">
                                        <span>You: <span className="you">{h.player}</span></span>
                                        <span>AI: <span className="opp">{h.ai}</span></span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function Play1v1Page({ onNavigate, playerId }) {
            const [username, setUsername] = useState('');
            const [status, setStatus] = useState('idle'); // idle, searching, matched, playing
            const [matchId, setMatchId] = useState(null);
            const [opponent, setOpponent] = useState('');
            const [gameState, setGameState] = useState(null);
            const [history, setHistory] = useState([]);
            const [loading, setLoading] = useState(false);
            const [pollInterval, setPollInterval] = useState(null);

            const findMatch = async () => {
                if (!username.trim()) {
                    alert('Please enter a username');
                    return;
                }

                setStatus('searching');

                try {
                    const res = await fetch('/api/matchmaking', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'find_match', playerId, username })
                    });

                    const data = await res.json();

                    if (data.status === 'matched') {
                        setMatchId(data.matchId);
                        setOpponent(data.opponent);
                        setStatus('playing');
                        startPolling(data.matchId);
                    } else if (data.status === 'waiting') {
                        startCheckingForMatch();
                    }
                } catch (e) {
                    setStatus('idle');
                    alert('Failed to connect to matchmaking server');
                }
            };

            const startCheckingForMatch = () => {
                const interval = setInterval(async () => {
                    try {
                        const res = await fetch('/api/matchmaking', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ action: 'check_match', playerId })
                        });

                        const data = await res.json();

                        if (data.status === 'matched') {
                            clearInterval(interval);
                            setMatchId(data.matchId);
                            setOpponent(data.opponent);
                            setStatus('playing');
                            startPolling(data.matchId);
                        }
                    } catch (e) {
                        console.error('Check match error:', e);
                    }
                }, 2000);

                setPollInterval(interval);
            };

            const startPolling = (mId) => {
                const interval = setInterval(() => fetchGameState(mId), 1500);
                setPollInterval(interval);
                fetchGameState(mId);
            };

            const fetchGameState = async (mId) => {
                try {
                    const res = await fetch('/api/matchmaking', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'get_game_state', matchId: mId, playerId })
                    });

                    const data = await res.json();
                    setGameState(data);

                    if (data.lastResult && data.lastMyMove) {
                        setHistory(prev => {
                            if (prev.length === 0 || prev[0].you !== data.lastMyMove || prev[0].opp !== data.lastOpponentMove) {
                                return [{ you: data.lastMyMove, opp: data.lastOpponentMove }, ...prev.slice(0, 9)];
                            }
                            return prev;
                        });
                    }

                    if (data.status === 'finished') {
                        clearInterval(pollInterval);
                    }
                } catch (e) {
                    console.error('Fetch state error:', e);
                }
            };

            const submitMove = async (move) => {
                setLoading(true);

                try {
                    await fetch('/api/matchmaking', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'submit_move', matchId, playerId, move })
                    });
                } catch (e) {
                    console.error('Submit move error:', e);
                }

                setLoading(false);
            };

            const leaveQueue = async () => {
                if (pollInterval) clearInterval(pollInterval);

                await fetch('/api/matchmaking', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'leave_queue', playerId })
                });

                setStatus('idle');
            };

            const resetMatch = () => {
                if (pollInterval) clearInterval(pollInterval);
                setStatus('idle');
                setMatchId(null);
                setOpponent('');
                setGameState(null);
                setHistory([]);
            };

            useEffect(() => {
                return () => {
                    if (pollInterval) clearInterval(pollInterval);
                };
            }, [pollInterval]);

            const myCharges = gameState?.myCharges || 0;
            const legalMoves = getLegalMoves(myCharges);

            return (
                <div className="game-container">
                    <div className="game-header">
                        <img src="/fireball_logo.png" alt="" className="game-logo" />
                        <h1 className="game-title">Play Online</h1>
                        <button className="back-btn" onClick={() => { leaveQueue(); onNavigate('home'); }}>Back</button>
                    </div>

                    {status === 'idle' && (
                        <div className="matchmaking-status">
                            <p>Enter a username to find an opponent</p>
                            <input
                                type="text"
                                className="input-field"
                                placeholder="Username"
                                value={username}
                                onChange={e => setUsername(e.target.value)}
                                onKeyDown={e => e.key === 'Enter' && findMatch()}
                            />
                            <br />
                            <button className="btn btn-primary" onClick={findMatch}>Find Match</button>
                        </div>
                    )}

                    {status === 'searching' && (
                        <div className="matchmaking-status">
                            <p>Searching for an opponent...</p>
                            <div className="loader"></div>
                            <button className="btn btn-secondary" onClick={leaveQueue} style={{ marginTop: '1rem' }}>Cancel</button>
                        </div>
                    )}

                    {status === 'playing' && gameState && (
                        <>
                            {gameState.status === 'finished' ? (
                                <div className="end-game">
                                    <h2 className={`end-title ${gameState.winner === (gameState.myCharges >= gameState.opponentCharges ? 'player1' : 'player2') ? 'lose' : 'win'}`}>
                                        {gameState.winner === 'player1' ? (opponent + ' Wins') : 'You Win'}
                                    </h2>
                                    <button className="btn btn-primary" onClick={resetMatch}>Play Again</button>
                                </div>
                            ) : (
                                <>
                                    <p style={{ textAlign: 'center', color: 'var(--text-secondary)', marginBottom: '1.5rem' }}>
                                        Playing against <strong style={{ color: 'var(--accent-purple)' }}>{opponent}</strong>
                                        {gameState.opponentSubmitted && <span> - Waiting for you</span>}
                                    </p>

                                    <div className="charge-display">
                                        <div className="charge-block player-charge">
                                            <div className="charge-label">Your Charges</div>
                                            <div className="charge-value">{gameState.myCharges}</div>
                                        </div>
                                        <div className="charge-block opponent-charge">
                                            <div className="charge-label">{opponent}</div>
                                            <div className="charge-value">{gameState.opponentCharges}</div>
                                        </div>
                                    </div>

                                    <div className="moves-grid">
                                        {MOVES.map(move => (
                                            <button
                                                key={move.id}
                                                className="move-btn"
                                                disabled={loading || !legalMoves.includes(move.id)}
                                                onClick={() => submitMove(move.id)}
                                            >
                                                <span>{move.name}</span>
                                                <span className="cost">{move.costDisplay}</span>
                                            </button>
                                        ))}
                                    </div>

                                    {history.length > 0 && (
                                        <div className="history-section">
                                            <h3 className="history-title">History</h3>
                                            <div className="history-list">
                                                {history.map((h, i) => (
                                                    <div key={i} className="history-item">
                                                        <span>You: <span className="you">{h.you}</span></span>
                                                        <span>{opponent}: <span className="opp">{h.opp}</span></span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </>
                            )}
                        </>
                    )}
                </div>
            );
        }

        function App() {
            const getPageFromUrl = () => {
                const path = window.location.pathname;
                if (path === '/guide') return 'guide';
                if (path === '/playai') return 'play-ai';
                if (path === '/online') return 'play-1v1';
                return 'home';
            };

            const [page, setPage] = useState(getPageFromUrl());
            const [onlineCount, setOnlineCount] = useState(0);
            const [playerId] = useState(() => 'player_' + Math.random().toString(36).substr(2, 9));

            // URL routing
            const navigate = (newPage) => {
                const paths = {
                    'home': '/',
                    'guide': '/guide',
                    'play-ai': '/playai',
                    'play-1v1': '/online'
                };
                window.history.pushState({}, '', paths[newPage] || '/');
                setPage(newPage);
            };

            // Handle browser back/forward
            useEffect(() => {
                const handlePopState = () => {
                    setPage(getPageFromUrl());
                };
                window.addEventListener('popstate', handlePopState);
                return () => window.removeEventListener('popstate', handlePopState);
            }, []);

            // Heartbeat for online players tracking
            useEffect(() => {
                const sendHeartbeat = async () => {
                    try {
                        await fetch('/api/matchmaking', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ action: 'heartbeat', playerId })
                        });

                        const res = await fetch('/api/matchmaking', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ action: 'get_online_count' })
                        });
                        const data = await res.json();
                        setOnlineCount(data.count || 0);
                    } catch (e) {
                        console.log('Heartbeat error');
                    }
                };

                sendHeartbeat();
                const interval = setInterval(sendHeartbeat, 30000);
                return () => clearInterval(interval);
            }, [playerId]);

            return (
                <div className="app">
                    {page === 'home' && <HomePage onNavigate={navigate} onlineCount={onlineCount} />}
                    {page === 'guide' && <GuidePage onNavigate={navigate} />}
                    {page === 'play-ai' && <PlayAIPage onNavigate={navigate} />}
                    {page === 'play-1v1' && <Play1v1Page onNavigate={navigate} playerId={playerId} />}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>